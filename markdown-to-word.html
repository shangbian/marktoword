<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown è½¬ Word å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-docx-js@0.3.1/dist/html-docx.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 12px;
            color: #999;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            background: #f0f2ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .file-size {
            font-size: 12px;
            color: #666;
        }

        .preview-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .preview-content {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .preview-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .preview-content table th,
        .preview-content table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .preview-content table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .preview-content table tr:nth-child(even) {
            background: #f8f9ff;
        }

        .preview-content table tr:hover {
            background: #f0f2ff;
        }

        .preview-content h1,
        .preview-content h2,
        .preview-content h3,
        .preview-content h4,
        .preview-content h5,
        .preview-content h6 {
            margin: 20px 0 10px 0;
            color: #333;
        }

        .preview-content h1 {
            font-size: 24px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .preview-content h2 {
            font-size: 20px;
        }

        .preview-content h3 {
            font-size: 18px;
        }

        .preview-content ul,
        .preview-content ol {
            margin: 10px 0 10px 20px;
        }

        .preview-content li {
            margin: 5px 0;
        }

        .preview-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin: 15px 0;
            color: #666;
            font-style: italic;
        }

        .preview-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .preview-content pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .preview-content pre code {
            background: none;
            padding: 0;
        }

        /* Mermaid å›¾è¡¨æ ·å¼ */
        .mermaid-diagram {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 8px;
            text-align: center;
            overflow-x: auto;
            display: block;
            width: 100%;
            min-height: 200px;
            min-width: 400px;
        }
        
        /* ERå›¾éœ€è¦æ›´å¤§çš„ç©ºé—´ */
        .mermaid-diagram:has(.mermaid[data-type="er"]) {
            min-width: 800px;
            min-height: 600px;
        }

        .mermaid-diagram .mermaid {
            display: block;
            width: 100%;
            min-width: 400px;
            min-height: 300px;
        }
        
        /* ERå›¾å®¹å™¨ */
        .mermaid-diagram .mermaid[data-type="er"] {
            min-width: 800px;
            min-height: 600px;
        }

        .mermaid-diagram svg {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        /* ä¿®å¤ NaN é—®é¢˜ï¼šç¡®ä¿ SVG æœ‰æœ‰æ•ˆçš„å°ºå¯¸ */
        .mermaid-diagram svg[width="NaN"],
        .mermaid-diagram svg[height="NaN"] {
            width: 800px !important;
            height: 600px !important;
        }
        
        .mermaid-diagram svg:not([width]),
        .mermaid-diagram svg:not([height]) {
            width: 800px;
            height: auto;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }

        .success-message.show {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 12px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .content {
                padding: 20px;
            }

            .upload-area {
                padding: 30px 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“„ Markdown è½¬ Word å·¥å…·</h1>
            <p>æ”¯æŒå¯¼å…¥ Markdown æ–‡ä»¶å¹¶è½¬æ¢ä¸º Word æ–‡æ¡£ï¼Œå®Œç¾æ¸²æŸ“è¡¨æ ¼</p>
        </div>

        <div class="content">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ Markdown æ–‡ä»¶åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒ .md å’Œ .markdown æ ¼å¼æ–‡ä»¶</div>
                <input type="file" id="fileInput" accept=".md,.markdown,text/markdown">
            </div>

            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>

            <div class="preview-section" id="previewSection" style="display: none;">
                <div class="section-title">ğŸ“‹ é¢„è§ˆ</div>
                <div class="preview-content" id="previewContent"></div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>æ­£åœ¨ç”Ÿæˆ Word æ–‡æ¡£...</div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="convertBtn" disabled>
                    <span>ğŸ’¾</span>
                    <span>è½¬æ¢ä¸º Word æ–‡æ¡£</span>
                </button>
                <button class="btn btn-secondary" id="clearBtn" style="display: none;">
                    <span>ğŸ”„</span>
                    <span>æ¸…é™¤</span>
                </button>
            </div>

            <div class="success-message" id="successMessage">
                âœ… Word æ–‡æ¡£ç”ŸæˆæˆåŠŸï¼
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const previewSection = document.getElementById('previewSection');
        const previewContent = document.getElementById('previewContent');
        const convertBtn = document.getElementById('convertBtn');
        const clearBtn = document.getElementById('clearBtn');
        const loading = document.getElementById('loading');
        const successMessage = document.getElementById('successMessage');

        let markdownContent = '';
        let currentFileName = '';

        // å…¨å±€é”™è¯¯å¤„ç†ï¼šæ•è·Mermaidæ¸²æŸ“é”™è¯¯ï¼ˆåŒ…æ‹¬NaNé”™è¯¯ï¼‰
        window.addEventListener('error', function(event) {
            const errorMsg = event.message || '';
            const isMermaidError = (
                errorMsg.includes('NaN') || 
                errorMsg.includes('Expected number') ||
                errorMsg.includes('attribute d') ||
                errorMsg.includes('Syntax error') ||
                (event.filename && event.filename.includes('mermaid'))
            );
            
            if (isMermaidError) {
                console.error('[Mermaidå…¨å±€é”™è¯¯æ•è·]', {
                    message: errorMsg,
                    filename: event.filename,
                    lineno: event.lineno
                });
                
                // æŸ¥æ‰¾æœ€è¿‘çš„Mermaidå®¹å™¨å¹¶æ˜¾ç¤ºé”™è¯¯
                const mermaidContainers = document.querySelectorAll('.mermaid');
                if (mermaidContainers.length > 0) {
                    const lastContainer = mermaidContainers[mermaidContainers.length - 1];
                    if (lastContainer && !lastContainer.querySelector('.mermaid-error')) {
                        const mermaidCode = lastContainer.textContent || '';
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'mermaid-error';
                        errorDiv.style.cssText = 'color: #f44336; padding: 20px; border: 1px solid #f44336; border-radius: 8px; background: rgba(244, 67, 54, 0.1); margin: 10px 0;';
                        errorDiv.innerHTML = `
                            <strong>âš ï¸ Mermaidå›¾è¡¨æ¸²æŸ“é”™è¯¯</strong><br>
                            <small>é”™è¯¯ä¿¡æ¯: ${errorMsg}</small><br>
                            ${errorMsg.includes('NaN') ? '<small style="color: #ff9800;">æç¤º: è¿™å¯èƒ½æ˜¯ç”±äºå›¾è¡¨å®šä¹‰é—®é¢˜æˆ–å®¹å™¨å°ºå¯¸é—®é¢˜å¯¼è‡´çš„</small><br>' : ''}
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #666;">æŸ¥çœ‹ä»£ç </summary>
                                <pre style="margin-top: 5px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-size: 12px; overflow-x: auto; max-height: 200px; overflow-y: auto;">${mermaidCode.substring(0, 1000)}</pre>
                            </details>
                        `;
                        lastContainer.parentNode.insertBefore(errorDiv, lastContainer.nextSibling);
                    }
                }
                
                event.preventDefault();
                return true;
            }
        }, true);
        
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            suppressErrors: true,
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#fff',
                primaryBorderColor: '#5568d3',
                lineColor: '#667eea',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif',
                fontSize: '14px'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 20,
                nodeSpacing: 50,
                rankSpacing: 50
            },
            // ERå›¾ç‰¹æ®Šé…ç½®
            er: {
                useMaxWidth: true,
                diagramPadding: 20,
                layoutDirection: 'TB'
            }
        });

        // é…ç½® markedï¼Œæ”¯æŒ mermaid ä»£ç å—
        const renderer = new marked.Renderer();
        
        // è‡ªå®šä¹‰ä»£ç å—æ¸²æŸ“å™¨ï¼Œå¤„ç† mermaid ä»£ç å—
        renderer.code = function(code, language) {
            if (language === 'mermaid') {
                // æ¸…ç†ä»£ç å†…å®¹ï¼Œç§»é™¤å¯èƒ½çš„ç©ºç™½å­—ç¬¦
                const cleanCode = code.trim();
                if (!cleanCode) {
                    return `<pre><code class="language-mermaid">${code}</code></pre>`;
                }
                
                // æ£€æµ‹æ˜¯å¦æ˜¯ERå›¾
                const isERDiagram = cleanCode.trim().toLowerCase().startsWith('erdiagram') ||
                    cleanCode.includes('erDiagram');
                
                // é¢„å¤„ç†ERå›¾ä»£ç ï¼Œç§»é™¤å…³ç³»æè¿°ä¸­çš„ä¸­æ–‡
                let processedCode = cleanCode;
                if (isERDiagram) {
                    const lines = cleanCode.split('\n');
                    const processedLines = [];
                    
                    for (let i = 0; i < lines.length; i++) {
                        let line = lines[i];
                        // æ£€æµ‹æ˜¯å¦æ˜¯å…³ç³»å®šä¹‰è¡Œ
                        const isRelationLine = /^\s*\w+\s*(\|\||--|o\{|\}o|\|o|o\|)/.test(line);
                        
                        if (isRelationLine) {
                            // ç§»é™¤å…³ç³»æè¿°ä¸­çš„ä¸­æ–‡ï¼ˆå†’å·åçš„ä¸­æ–‡éƒ¨åˆ†ï¼‰
                            line = line.replace(/:\s*[\u4e00-\u9fa5]+.*$/, '');
                            line = line.replace(/:\s*$/, '');
                        }
                        
                        processedLines.push(line);
                    }
                    
                    processedCode = processedLines.join('\n');
                }
                
                const isComplexDiagram = isERDiagram || processedCode.split('\n').length > 20;
                
                // æ ¹æ®å›¾è¡¨ç±»å‹è®¾ç½®ä¸åŒçš„æœ€å°å°ºå¯¸
                const minWidth = isComplexDiagram ? '800px' : '400px';
                const minHeight = isComplexDiagram ? '600px' : '300px';
                
                // ä¸º mermaid ä»£ç å—ç”Ÿæˆå”¯ä¸€ID
                const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                const dataType = isERDiagram ? 'data-type="er"' : '';
                return `<div class="mermaid-diagram" data-mermaid-id="${id}">
                    <div class="mermaid" id="${id}" ${dataType} style="display: block; width: 100%; min-width: ${minWidth}; min-height: ${minHeight};">${processedCode}</div>
                </div>`;
            }
            // å…¶ä»–ä»£ç å—ä½¿ç”¨é»˜è®¤æ¸²æŸ“
            return `<pre><code class="language-${language}">${this.options.highlight ? this.options.highlight(code, language) : code}</code></pre>`;
        };

        marked.setOptions({
            breaks: true,
            gfm: true,
            tables: true,
            renderer: renderer
        });

        // ç­‰å¾…åº“åŠ è½½
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (checkLibraryLoaded()) {
                    console.log('Word è½¬æ¢åº“å·²æˆåŠŸåŠ è½½');
                } else {
                    console.warn('Word è½¬æ¢åº“å¯èƒ½æœªæ­£ç¡®åŠ è½½ã€‚å¯ç”¨çš„å…¨å±€å˜é‡:', {
                        HTMLDocx: typeof HTMLDocx,
                        htmlDocx: typeof htmlDocx,
                        asBlob: typeof asBlob
                    });
                }
            }, 1000);
        });

        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.md') || file.name.endsWith('.markdown'))) {
                handleFile(file);
            } else {
                alert('è¯·é€‰æ‹© Markdown æ–‡ä»¶ï¼ˆ.md æˆ– .markdownï¼‰');
            }
        });

        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            currentFileName = file.name.replace(/\.(md|markdown)$/i, '');
            fileName.textContent = file.name;
            fileSize.textContent = `æ–‡ä»¶å¤§å°: ${(file.size / 1024).toFixed(2)} KB`;
            fileInfo.classList.add('show');

            const reader = new FileReader();
            reader.onload = async (e) => {
                markdownContent = e.target.result;
                convertBtn.disabled = true;
                loading.classList.add('show');
                try {
                    await renderPreview();
                } catch (error) {
                    console.error('æ¸²æŸ“é¢„è§ˆå¤±è´¥:', error);
                    alert('æ¸²æŸ“é¢„è§ˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯');
                } finally {
                    loading.classList.remove('show');
                    convertBtn.disabled = false;
                    clearBtn.style.display = 'inline-flex';
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // GLMä»£ç†æœåŠ¡å™¨é…ç½®
        const PROXY_API_URL = 'http://localhost:8888/api/glm';

        // é€šè¿‡ä»£ç†æœåŠ¡å™¨è°ƒç”¨GLMæ¨¡å‹ç”Ÿæˆæ–‡æœ¬è¯´æ˜
        async function callGLMAPI(content) {
            try {
                console.log('é€šè¿‡ä»£ç†æœåŠ¡å™¨è°ƒç”¨GLMæ¨¡å‹ï¼Œå†…å®¹é•¿åº¦:', content.length);
                const prompt = `è¯·ç”¨ç®€æ´æ˜äº†çš„æ–‡å­—è¯´æ˜ä»¥ä¸‹å†…å®¹ï¼Œä¸éœ€è¦ç»“æ„åŒ–è®¾è®¡ï¼Œåªéœ€è¦æ¸…æ™°çš„æ–‡æœ¬æè¿°ï¼š\n\n${content}`;
                
                const response = await fetch(PROXY_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: prompt
                    })
                });

                console.log('ä»£ç†æœåŠ¡å™¨å“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ä»£ç†æœåŠ¡å™¨é”™è¯¯å“åº”:', errorText);
                    let errorMessage = `ä»£ç†æœåŠ¡å™¨è°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error) {
                            errorMessage = errorData.error;
                            // å¦‚æœæ˜¯ä½™é¢ä¸è¶³é”™è¯¯ï¼Œæä¾›å‹å¥½çš„æç¤º
                            if (errorMessage.includes('ä½™é¢ä¸è¶³') || errorMessage.includes('å……å€¼')) {
                                errorMessage = `GLM APIä½™é¢ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆæ–‡æœ¬è¯´æ˜ã€‚è¯·è®¿é—® https://open.bigmodel.cn å……å€¼åé‡è¯•ã€‚å°†ä¿ç•™åŸå§‹ä»£ç å—å†…å®¹ã€‚`;
                            }
                        }
                    } catch (e) {
                        errorMessage += ` - ${errorText}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('ä»£ç†æœåŠ¡å™¨è¿”å›æ•°æ®:', data);
                
                // ä»£ç†æœåŠ¡å™¨è¿”å›æ ¼å¼ï¼šdata.text
                if (data.text) {
                    return data.text;
                } else if (data.error) {
                    // å¦‚æœæ˜¯ä½™é¢ä¸è¶³é”™è¯¯ï¼Œæä¾›å‹å¥½çš„æç¤º
                    if (data.error.includes('ä½™é¢ä¸è¶³') || data.error.includes('å……å€¼')) {
                        throw new Error(`GLM APIä½™é¢ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆæ–‡æœ¬è¯´æ˜ã€‚è¯·è®¿é—® https://open.bigmodel.cn å……å€¼åé‡è¯•ã€‚å°†ä¿ç•™åŸå§‹ä»£ç å—å†…å®¹ã€‚`);
                    }
                    throw new Error(data.error);
                } else {
                    console.error('ä»£ç†æœåŠ¡å™¨è¿”å›æ ¼å¼å¼‚å¸¸ï¼Œå®Œæ•´å“åº”:', JSON.stringify(data, null, 2));
                    throw new Error('ä»£ç†æœåŠ¡å™¨è¿”å›æ ¼å¼å¼‚å¸¸ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
                }
            } catch (error) {
                // ä»£ç†æœªå¯åŠ¨æˆ–ç½‘ç»œé”™è¯¯ï¼šä¸æŠ›é”™ï¼Œè¿”å› nullï¼Œç”±è°ƒç”¨æ–¹ä¿ç•™åŸæ–‡å¹¶ç»§ç»­è½¬æ¢
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    if (!window._glmConnectionWarningShown) {
                        console.warn('GLM æœåŠ¡æœªè¿æ¥ï¼ˆlocalhost:8888ï¼‰ï¼Œç›¸å…³ä»£ç å—å°†ä¿ç•™åŸæ–‡ã€‚å¦‚éœ€ AI è¯´æ˜å¯è¿è¡Œ: python3 glm_proxy.py');
                        window._glmConnectionWarningShown = true;
                    }
                    return null;
                }
                console.error('GLM APIè°ƒç”¨é”™è¯¯:', error);
                throw error;
            }
        }

        // è¯†åˆ«å¹¶å¤„ç†æµç¨‹ã€æ ‘çŠ¶ç»“æ„å’Œç¤ºä¾‹ä»£ç å—
        function isSpecialCodeBlock(content) {
            // æ£€æµ‹æ˜¯å¦æ˜¯ Mermaid ä»£ç å—ï¼ˆä¸å¤„ç†ï¼Œä¿ç•™åŸæ ·ç”¨äºæ¸²æŸ“ï¼‰
            const isMermaid = /^\s*(flowchart|graph|sequenceDiagram|classDiagram|stateDiagram|erDiagram|gantt|pie|gitgraph|journey|requirement)/i.test(content.trim());
            if (isMermaid) {
                return false; // Mermaid ä»£ç å—ä¸è°ƒç”¨ GLMï¼Œä¿ç•™åŸæ ·ç”¨äºæ¸²æŸ“
            }
            
            // æ£€æµ‹æ˜¯å¦æ˜¯æµç¨‹è¯´æ˜
            const isFlow = /[â†“â†’â†â†‘â”€]|æµç¨‹|å®¡æ‰¹|éªŒè¯|æäº¤|å®¡æ ¸|é€šè¿‡|å¤±è´¥/.test(content);
            // æ£€æµ‹æ˜¯å¦æ˜¯æ ‘çŠ¶ç»“æ„
            const isTree = /[â”œâ””â”‚â”€]/.test(content);
            // æ£€æµ‹æ˜¯å¦æ˜¯ç¤ºä¾‹ï¼ˆåŒ…å«"ç¤ºä¾‹"ã€"å¦‚"ã€"ä¾‹å¦‚"ç­‰å…³é”®è¯ï¼‰
            const isExample = /ç¤ºä¾‹|å¦‚ï¼š|ä¾‹å¦‚|ç¤ºä¾‹ï¼š/.test(content);
            
            return isFlow || isTree || isExample;
        }

        // å¤„ç†Markdownå†…å®¹ï¼Œåªå¯¹ä»£ç å—ï¼ˆç°è‰²èƒŒæ™¯ï¼‰ä¸­çš„ç‰¹æ®Šå†…å®¹è°ƒç”¨GLMç”Ÿæˆè¯´æ˜
        // æ³¨æ„ï¼šåªå¤„ç†ä»£ç å—ï¼Œå…¶ä»–å†…å®¹ï¼ˆè¡¨æ ¼ã€æ ‡é¢˜ã€åˆ—è¡¨ç­‰ï¼‰ä¿æŒæ­£å¸¸æ¸²æŸ“
        async function processMarkdownWithGLM(markdown) {
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ä»£ç å—ï¼ˆ```ä»£ç å—```ï¼‰
            const codeBlockRegex = /```[\s\S]*?```/g;
            const codeBlocks = markdown.match(codeBlockRegex) || [];
            
            let processedMarkdown = markdown;
            
            // ä»åå¾€å‰å¤„ç†ï¼Œé¿å…æ›¿æ¢ä½ç½®åç§»
            for (let i = codeBlocks.length - 1; i >= 0; i--) {
                const codeBlock = codeBlocks[i];
                // æå–ä»£ç å—å†…å®¹ï¼ˆå»é™¤```å’Œè¯­è¨€æ ‡è¯†ï¼‰
                const contentMatch = codeBlock.match(/```(?:\w+)?\n?([\s\S]*?)```/);
                if (contentMatch && contentMatch[1]) {
                    const content = contentMatch[1].trim();
                    const languageMatch = codeBlock.match(/```(\w+)/);
                    const language = languageMatch ? languageMatch[1].toLowerCase() : '';
                    
                    // Mermaid ä»£ç å—ä¸å¤„ç†ï¼Œä¿ç•™åŸæ ·ç”¨äºæ¸²æŸ“
                    if (language === 'mermaid') {
                        continue; // è·³è¿‡ Mermaid ä»£ç å—ï¼Œä¿ç•™åŸæ ·
                    }
                    
                    // åªå¯¹ç‰¹æ®Šä»£ç å—ï¼ˆæµç¨‹ã€æ ‘çŠ¶ç»“æ„ã€ç¤ºä¾‹ï¼‰è°ƒç”¨GLM API
                    // å…¶ä»–ä»£ç å—ä¿æŒåŸæ ·ï¼Œå…¶ä»–å†…å®¹ï¼ˆè¡¨æ ¼ã€æ ‡é¢˜ã€åˆ—è¡¨ç­‰ï¼‰å®Œå…¨ä¸å—å½±å“
                    if (isSpecialCodeBlock(content)) {
                        try {
                            const explanation = await callGLMAPI(content);
                            if (explanation != null) {
                                processedMarkdown = processedMarkdown.replace(
                                    codeBlock,
                                    `\n\n**è¯´æ˜ï¼š**\n\n${explanation}\n\n`
                                );
                            }
                            // explanation ä¸º null æ—¶ï¼ˆå¦‚ä»£ç†æœªå¯åŠ¨ï¼‰ä¿ç•™åŸä»£ç å—ï¼Œä¸æ›¿æ¢
                        } catch (error) {
                            console.warn('å¤„ç†ä»£ç å—æ—¶å‡ºé”™ï¼Œä¿ç•™åŸå†…å®¹:', error);
                            // å¦‚æœæ˜¯ä½™é¢ä¸è¶³ï¼Œåœ¨æ§åˆ¶å°ç»™å‡ºæ˜ç¡®æç¤ºï¼ˆåªæç¤ºä¸€æ¬¡ï¼‰
                            if (error.message && error.message.includes('ä½™é¢ä¸è¶³') && !window._balanceWarningShown) {
                                console.error('âš ï¸ GLM APIä½™é¢ä¸è¶³ï¼Œæ‰€æœ‰ç‰¹æ®Šä»£ç å—å°†ä¿ç•™åŸå§‹æ ¼å¼');
                                console.error('   è¯·è®¿é—® https://open.bigmodel.cn æˆ– https://right.codes å……å€¼ååˆ·æ–°é¡µé¢é‡è¯•');
                                // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå‹å¥½çš„æç¤º
                                const warningDiv = document.createElement('div');
                                warningDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 12px 16px; max-width: 400px; z-index: 10000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);';
                                warningDiv.innerHTML = `
                                    <div style="font-weight: bold; color: #856404; margin-bottom: 8px;">âš ï¸ GLM APIä½™é¢ä¸è¶³</div>
                                    <div style="color: #856404; font-size: 14px; margin-bottom: 8px;">ç‰¹æ®Šä»£ç å—å°†ä¿ç•™åŸå§‹æ ¼å¼</div>
                                    <div style="font-size: 12px; color: #856404;">
                                        è¯·è®¿é—® <a href="https://open.bigmodel.cn" target="_blank" style="color: #0066cc;">open.bigmodel.cn</a> 
                                        æˆ– <a href="https://right.codes" target="_blank" style="color: #0066cc;">right.codes</a> å……å€¼ååˆ·æ–°é¡µé¢é‡è¯•
                                    </div>
                                    <button onclick="this.parentElement.remove()" style="margin-top: 8px; padding: 4px 12px; background: #ffc107; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">çŸ¥é“äº†</button>
                                `;
                                document.body.appendChild(warningDiv);
                                // 5ç§’åè‡ªåŠ¨å…³é—­
                                setTimeout(() => {
                                    if (warningDiv.parentElement) {
                                        warningDiv.remove();
                                    }
                                }, 10000);
                                window._balanceWarningShown = true;
                            }
                            // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä¿ç•™åŸä»£ç å—ï¼Œä¸å½±å“å…¶ä»–å†…å®¹
                        }
                    }
                    // å¦‚æœä¸æ˜¯ç‰¹æ®Šä»£ç å—ï¼Œä¿æŒåŸæ ·ï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†
                }
            }
            
            // è¿”å›å¤„ç†åçš„Markdownï¼Œå…¶ä»–å†…å®¹ï¼ˆè¡¨æ ¼ã€æ ‡é¢˜ã€åˆ—è¡¨ç­‰ï¼‰ä¿æŒä¸å˜
            return processedMarkdown;
        }

        // é¢„å¤„ç†ERå›¾ä»£ç ï¼Œç§»é™¤å…³ç³»æè¿°ä¸­çš„ä¸­æ–‡å­—ç¬¦
        function preprocessERDiagramCode(mermaidCode) {
            if (!mermaidCode.trim().toLowerCase().startsWith('erdiagram') && 
                !mermaidCode.includes('erDiagram')) {
                return mermaidCode; // ä¸æ˜¯ERå›¾ï¼Œç›´æ¥è¿”å›
            }
            
            const lines = mermaidCode.split('\n');
            const processedLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // æ£€æµ‹æ˜¯å¦æ˜¯å…³ç³»å®šä¹‰è¡Œï¼ˆåŒ…å« ||, --, o{, }o, |o, o| ç­‰ï¼‰
                const isRelationLine = /^\s*\w+\s*(\|\||--|o\{|\}o|\|o|o\|)/.test(line);
                
                if (isRelationLine) {
                    // ç§»é™¤å…³ç³»æè¿°ä¸­çš„ä¸­æ–‡ï¼ˆå†’å·åçš„ä¸­æ–‡éƒ¨åˆ†ï¼‰
                    // åŒ¹é…æ¨¡å¼ï¼š: ä¸­æ–‡å†…å®¹
                    line = line.replace(/:\s*[\u4e00-\u9fa5]+.*$/, '');
                    // å¦‚æœè¿˜æœ‰å†’å·ä½†æ²¡æœ‰å†…å®¹ï¼Œä¹Ÿç§»é™¤å†’å·
                    line = line.replace(/:\s*$/, '');
                }
                
                processedLines.push(line);
            }
            
            return processedLines.join('\n');
        }
        
        // å®‰å…¨çš„Mermaidæ¸²æŸ“å‡½æ•°
        async function safeRenderMermaid(element, mermaidCode) {
            try {
                // é¢„å¤„ç†ERå›¾ä»£ç ï¼Œç§»é™¤å…³ç³»æè¿°ä¸­çš„ä¸­æ–‡
                const processedCode = preprocessERDiagramCode(mermaidCode);
                
                // æ£€æµ‹å›¾è¡¨ç±»å‹ï¼ŒERå›¾éœ€è¦æ›´å¤§çš„å®¹å™¨
                const isERDiagram = processedCode.trim().toLowerCase().startsWith('erdiagram') ||
                    processedCode.includes('erDiagram');
                const isComplexDiagram = isERDiagram || processedCode.split('\n').length > 20;
                
                // æ ¹æ®å›¾è¡¨ç±»å‹è®¾ç½®ä¸åŒçš„æœ€å°å°ºå¯¸
                const minWidth = isComplexDiagram ? '800px' : '400px';
                const minHeight = isComplexDiagram ? '600px' : '300px';
                
                // ç¡®ä¿å…ƒç´ æœ‰å°ºå¯¸ï¼ˆè¿™æ˜¯é˜²æ­¢NaNçš„å…³é”®ï¼‰
                if (!element.offsetWidth || !element.offsetHeight) {
                    element.style.display = 'block';
                    element.style.width = '100%';
                    element.style.minWidth = minWidth;
                    element.style.minHeight = minHeight;
                    // ç­‰å¾…æ ·å¼åº”ç”¨
                    await new Promise(resolve => setTimeout(resolve, 150));
                } else {
                    // å³ä½¿æœ‰å°ºå¯¸ï¼Œä¹Ÿç¡®ä¿æœ€å°å°ºå¯¸è¶³å¤Ÿ
                    if (element.offsetWidth < (isComplexDiagram ? 800 : 400)) {
                        element.style.minWidth = minWidth;
                    }
                    if (element.offsetHeight < (isComplexDiagram ? 600 : 300)) {
                        element.style.minHeight = minHeight;
                    }
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                // éªŒè¯å…ƒç´ å°ºå¯¸
                if (!element.offsetWidth || !element.offsetHeight) {
                    throw new Error('å®¹å™¨æ²¡æœ‰æœ‰æ•ˆçš„å°ºå¯¸ï¼Œæ— æ³•æ¸²æŸ“å›¾è¡¨');
                }
                
                // ERå›¾éœ€è¦æ›´å¤§çš„æ¸²æŸ“ç©ºé—´
                if (isERDiagram) {
                    // ç¡®ä¿çˆ¶å®¹å™¨ä¹Ÿæœ‰è¶³å¤Ÿç©ºé—´
                    let parent = element.parentElement;
                    while (parent && parent !== document.body) {
                        if (parent.offsetWidth < 800) {
                            parent.style.minWidth = '800px';
                        }
                        if (parent.offsetHeight < 600) {
                            parent.style.minHeight = '600px';
                        }
                        parent = parent.parentElement;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // éªŒè¯è¯­æ³•ï¼ˆä½¿ç”¨é¢„å¤„ç†åçš„ä»£ç ï¼‰
                try {
                    const parseResult = mermaid.parse(processedCode);
                    if (parseResult) {
                        console.warn('[Mermaid] è¯­æ³•è­¦å‘Š:', parseResult);
                    }
                } catch (parseError) {
                    // å¦‚æœé¢„å¤„ç†åçš„ä»£ç ä»ç„¶æœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                    console.error('[Mermaid] è¯­æ³•é”™è¯¯:', parseError);
                    throw new Error(`Mermaidè¯­æ³•é”™è¯¯: ${parseError.message}`);
                }
                
                // æ¸…ç©ºå…ƒç´ å†…å®¹ï¼Œå‡†å¤‡æ¸²æŸ“ï¼ˆä½¿ç”¨é¢„å¤„ç†åçš„ä»£ç ï¼‰
                element.innerHTML = '';
                element.textContent = processedCode;
                
                // ä¸ºERå›¾æ·»åŠ æ ‡è¯†
                if (isERDiagram) {
                    element.setAttribute('data-type', 'er');
                }
                
                // ç­‰å¾…DOMæ›´æ–°ï¼ˆERå›¾éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
                const waitTime = isERDiagram ? 200 : 100;
                await new Promise(resolve => setTimeout(resolve, waitTime));
                
                // ä½¿ç”¨PromiseåŒ…è£…ï¼Œè®¾ç½®è¶…æ—¶ï¼ˆERå›¾éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
                const timeoutDuration = isERDiagram ? 20000 : 10000;
                const renderPromise = mermaid.run({
                    nodes: [element],
                    suppressErrors: true
                });
                
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('æ¸²æŸ“è¶…æ—¶')), timeoutDuration);
                });
                
                // ç­‰å¾…æ¸²æŸ“å®Œæˆ
                await Promise.race([renderPromise, timeoutPromise]);
                
                // æ¸²æŸ“å®Œæˆåï¼Œæ£€æŸ¥æ˜¯å¦æœ‰NaNé”™è¯¯ï¼ˆERå›¾éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
                const checkWaitTime = isERDiagram ? 500 : 300;
                await new Promise(resolve => setTimeout(resolve, checkWaitTime));
                
                // æ£€æŸ¥ç”Ÿæˆçš„SVGä¸­æ˜¯å¦æœ‰NaN
                const svg = element.querySelector('svg');
                if (svg) {
                    const svgContent = svg.outerHTML;
                    if (svgContent.includes('NaN')) {
                        throw new Error('æ£€æµ‹åˆ°NaNå€¼ï¼Œå›¾è¡¨æ¸²æŸ“å¤±è´¥');
                    }
                    
                    // æ£€æŸ¥æ‰€æœ‰pathå…ƒç´ çš„då±æ€§
                    const paths = svg.querySelectorAll('path');
                    for (const path of paths) {
                        const d = path.getAttribute('d');
                        if (d && d.includes('NaN')) {
                            throw new Error('æ£€æµ‹åˆ°è·¯å¾„ä¸­åŒ…å«NaNå€¼');
                        }
                    }
                }
                
                return true;
            } catch (error) {
                console.error('[Mermaid] æ¸²æŸ“é”™è¯¯:', error);
                throw error;
            }
        }
        
        // æ¸²æŸ“ Mermaid å›¾è¡¨
        async function renderMermaidDiagrams(container) {
            const mermaidElements = container.querySelectorAll('.mermaid');
            for (let i = 0; i < mermaidElements.length; i++) {
                const element = mermaidElements[i];
                try {
                    // æ¸…ç©ºä¹‹å‰çš„å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
                    let mermaidCode = element.textContent.trim();
                    if (!mermaidCode) {
                        continue;
                    }
                    
                    // ä½¿ç”¨å®‰å…¨çš„æ¸²æŸ“å‡½æ•°ï¼ˆä¼šè‡ªåŠ¨é¢„å¤„ç†ERå›¾ï¼‰
                    await safeRenderMermaid(element, mermaidCode);
                } catch (error) {
                    console.error('Mermaid æ¸²æŸ“é”™è¯¯:', error);
                    const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
                    const originalCode = element.textContent || mermaidCode || '';
                    element.innerHTML = `<div style="color: #f44336; padding: 20px; border: 1px solid #f44336; border-radius: 8px; background: rgba(244, 67, 54, 0.1);">
                        <strong>âš ï¸ Mermaidå›¾è¡¨æ¸²æŸ“å¤±è´¥</strong><br>
                        <small>é”™è¯¯: ${errorMsg}</small><br>
                        ${errorMsg.includes('NaN') ? '<small style="color: #ff9800;">æç¤º: è¿™å¯èƒ½æ˜¯ç”±äºå›¾è¡¨å®šä¹‰é—®é¢˜æˆ–å®¹å™¨å°ºå¯¸é—®é¢˜å¯¼è‡´çš„</small><br>' : ''}
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #666;">æŸ¥çœ‹åŸå§‹ä»£ç </summary>
                            <pre style="margin-top: 5px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-size: 12px; overflow-x: auto; max-height: 200px; overflow-y: auto;">${originalCode.substring(0, 1000)}</pre>
                        </details>
                    </div>`;
                }
            }
        }

        // æ¸²æŸ“é¢„è§ˆ
        async function renderPreview() {
            try {
                // å¤„ç†Markdownå†…å®¹
                const processedMarkdown = await processMarkdownWithGLM(markdownContent);
                const html = marked.parse(processedMarkdown);
                previewContent.innerHTML = html;
                
                // å…ˆæ˜¾ç¤ºé¢„è§ˆåŒºåŸŸï¼Œç¡®ä¿å®¹å™¨æœ‰å°ºå¯¸
                previewSection.style.display = 'block';
                
                // ç­‰å¾… DOM æ›´æ–°
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // æ¸²æŸ“ Mermaid å›¾è¡¨
                await renderMermaidDiagrams(previewContent);
            } catch (error) {
                console.error('æ¸²æŸ“é¢„è§ˆå‡ºé”™:', error);
                // å¦‚æœå¤„ç†å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å†…å®¹
                const html = marked.parse(markdownContent);
                previewContent.innerHTML = html;
                previewSection.style.display = 'block';
                
                // ç­‰å¾… DOM æ›´æ–°
                await new Promise(resolve => setTimeout(resolve, 100));
                
                await renderMermaidDiagrams(previewContent);
            }
        }

        // æ£€æŸ¥åº“æ˜¯å¦å·²åŠ è½½
        function checkLibraryLoaded() {
            return typeof HTMLDocx !== 'undefined' || 
                   typeof htmlDocx !== 'undefined' || 
                   typeof asBlob !== 'undefined';
        }

        // è½¬æ¢ä¸º Word
        convertBtn.addEventListener('click', async () => {
            if (!markdownContent) {
                alert('è¯·å…ˆé€‰æ‹© Markdown æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥åº“æ˜¯å¦å·²åŠ è½½
            if (!checkLibraryLoaded()) {
                alert('Word è½¬æ¢åº“æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å€™å†è¯•ã€‚å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚');
                return;
            }

            loading.classList.add('show');
            convertBtn.disabled = true;
            successMessage.classList.remove('show');

            try {
                await convertToWord(markdownContent);
                successMessage.classList.add('show');
                setTimeout(() => {
                    successMessage.classList.remove('show');
                }, 3000);
            } catch (error) {
                console.error('è½¬æ¢å¤±è´¥:', error);
                alert('è½¬æ¢å¤±è´¥: ' + error.message);
            } finally {
                loading.classList.remove('show');
                convertBtn.disabled = false;
            }
        });

        // æ¸…é™¤
        clearBtn.addEventListener('click', () => {
            markdownContent = '';
            currentFileName = '';
            fileInput.value = '';
            fileInfo.classList.remove('show');
            previewSection.style.display = 'none';
            previewContent.innerHTML = '';
            convertBtn.disabled = true;
            clearBtn.style.display = 'none';
            successMessage.classList.remove('show');
        });

        // å°† SVG è½¬ä¸º PNG DataURLï¼ŒæŒ‰å†…å®¹è¾¹ç•Œè£å‰ªï¼Œä¸ç•™ç©ºç™½åŒºåŸŸ
        function svgToPngDataUrl(svgEl, optWidth, optHeight) {
            return new Promise((resolve, reject) => {
                try {
                    const svg = svgEl.cloneNode(true);
                    let width, height;
                    const padding = 0;
                    let box = null;
                    try {
                        if (svg.getBBox) box = svg.getBBox();
                        if (!box || box.width <= 0 || box.height <= 0) {
                            const g = svg.querySelector('g');
                            if (g && g.getBBox) box = g.getBBox();
                        }
                        if (box && box.width > 0 && box.height > 0) {
                            width = Math.round(box.width + padding * 2);
                            height = Math.round(box.height + padding * 2);
                            svg.setAttribute('viewBox', `${box.x - padding} ${box.y - padding} ${box.width + padding * 2} ${box.height + padding * 2}`);
                            svg.setAttribute('width', width);
                            svg.setAttribute('height', height);
                        } else {
                            throw new Error('no bbox');
                        }
                    } catch (_) {
                        const vb = (svgEl.getAttribute('viewBox') || '').trim().split(/\s+/);
                        if (vb.length === 4) {
                            const vw = parseFloat(vb[2]), vh = parseFloat(vb[3]);
                            if (vw > 0 && vh > 0) {
                                width = Math.round(vw);
                                height = Math.round(vh);
                                svg.setAttribute('viewBox', svgEl.getAttribute('viewBox'));
                                svg.setAttribute('width', width);
                                svg.setAttribute('height', height);
                            } else {
                                throw new Error('invalid viewBox');
                            }
                        } else {
                            let w = optWidth ?? parseFloat(svgEl.getAttribute('width')) ?? 800;
                            let h = optHeight ?? parseFloat(svgEl.getAttribute('height')) ?? 600;
                            if (!w || w !== w) w = 800;
                            if (!h || h !== h) h = 600;
                            width = Math.max(100, Math.round(w));
                            height = Math.max(100, Math.round(h));
                            svg.setAttribute('width', width);
                            svg.setAttribute('height', height);
                            if (!svg.getAttribute('viewBox')) {
                                svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
                            }
                        }
                    }

                    // é™åˆ¶å†…å®¹å°ºå¯¸
                    const maxContentPx = 624;
                    if (Math.max(width, height) > maxContentPx) {
                        const f = maxContentPx / Math.max(width, height);
                        width = Math.round(width * f);
                        height = Math.round(height * f);
                        svg.setAttribute('width', width);
                        svg.setAttribute('height', height);
                    }
                    const scale = 2;
                    let canvasW = width * scale;
                    let canvasH = height * scale;
                    // Word æŒ‰ 96 DPI æ˜¾ç¤ºï¼šå®½åº¦ â‰¤16.5cm(623px)ï¼Œé«˜åº¦ â‰¤22cm(831px)
                    const maxPngWidthPx = 623;
                    const maxPngHeightPx = 831;
                    if (canvasW > maxPngWidthPx || canvasH > maxPngHeightPx) {
                        const rW = maxPngWidthPx / canvasW;
                        const rH = maxPngHeightPx / canvasH;
                        const r = Math.min(rW, rH, 1);
                        canvasW = Math.round(canvasW * r);
                        canvasH = Math.round(canvasH * r);
                    }

                    const svgStr = new XMLSerializer().serializeToString(svg);
                    const dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgStr);
                    const img = new Image();
                    img.onload = function () {
                        const canvas = document.createElement('canvas');
                        canvas.width = canvasW;
                        canvas.height = canvasH;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, width, height, 0, 0, canvasW, canvasH);
                        try {
                            resolve(canvas.toDataURL('image/png'));
                        } catch (e) {
                            reject(e);
                        }
                    };
                    img.onerror = function () {
                        reject(new Error('SVG è½¬å›¾ç‰‡å¤±è´¥'));
                    };
                    img.src = dataUrl;
                } catch (error) {
                    reject(error);
                }
            });
        }

        // å°† Mermaid å›¾è¡¨è½¬æ¢ä¸ºå›¾ç‰‡ï¼ˆBase64ï¼‰ï¼šä¼˜å…ˆç”¨ SVGâ†’PNGï¼Œå¤±è´¥æ—¶å†ç”¨ html2canvas
        async function convertMermaidToImage(mermaidElement) {
            const svg = mermaidElement.querySelector('svg');
            if (!svg) {
                throw new Error('Mermaid SVG æœªæ‰¾åˆ°');
            }
            let w, h;
            try {
                const box = svg.getBBox ? svg.getBBox() : null;
                w = parseFloat(svg.getAttribute('width')) || box?.width || svg.clientWidth || mermaidElement.offsetWidth || 800;
                h = parseFloat(svg.getAttribute('height')) || box?.height || svg.clientHeight || mermaidElement.offsetHeight || 600;
            } catch (_) {
                w = 800;
                h = 600;
            }
            w = Math.max(400, Math.round(w));
            h = Math.max(300, Math.round(h));
            try {
                return await svgToPngDataUrl(svg, w, h);
            } catch (e1) {
                try {
                    const canvas = await html2canvas(mermaidElement, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        logging: false,
                        width: w,
                        height: h,
                        useCORS: true,
                        allowTaint: true
                    });
                    return canvas.toDataURL('image/png');
                } catch (e2) {
                    throw e1;
                }
            }
        }

        // å¤„ç† HTML ä¸­çš„ Mermaid å›¾è¡¨ï¼Œè½¬æ¢ä¸ºå›¾ç‰‡ï¼ˆå¯¼å‡º Word ç”¨ï¼‰
        // è‹¥ .mermaid å†…å·²æœ‰ SVGï¼ˆæ¥è‡ªé¢„è§ˆï¼‰ï¼Œç›´æ¥è½¬å›¾ï¼›å¦åˆ™åœ¨ä¸´æ—¶å®¹å™¨ä¸­æ¸²æŸ“åå†è½¬å›¾
        async function processMermaidInHTML(htmlString) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlString;
            
            const mermaidDiagrams = tempDiv.querySelectorAll('.mermaid-diagram');
            let needRender = false;
            for (const d of mermaidDiagrams) {
                const m = d.querySelector('.mermaid');
                if (m && (m.textContent || '').trim() && !m.querySelector('svg')) {
                    needRender = true;
                    break;
                }
            }
            if (needRender) {
                tempDiv.setAttribute('id', 'mermaid-export-container');
                tempDiv.style.cssText = 'position:absolute;left:-9999px;top:0;width:900px;min-height:700px;opacity:0.01;pointer-events:none;z-index:-1;';
                document.body.appendChild(tempDiv);
            }
            
            for (let i = 0; i < mermaidDiagrams.length; i++) {
                const diagram = mermaidDiagrams[i];
                const mermaidElement = diagram.querySelector('.mermaid');
                if (!mermaidElement) continue;
                
                const existingSvg = mermaidElement.querySelector('svg');
                const originalCode = (mermaidElement.textContent || '').trim();
                
                try {
                    if (existingSvg && !(existingSvg.outerHTML && existingSvg.outerHTML.includes('NaN'))) {
                        // å·²æœ‰æœ‰æ•ˆ SVGï¼ˆæ¥è‡ªé¢„è§ˆï¼‰ï¼Œç›´æ¥è½¬æˆå›¾ç‰‡å†™å…¥ Word
                        const imageData = await convertMermaidToImage(diagram);
                        const img = document.createElement('img');
                        img.src = imageData;
                        img.alt = 'Mermaid å›¾è¡¨';
                        img.style.width = '16.5cm';
                        img.style.maxWidth = '16.5cm';
                        img.style.height = 'auto';
                        img.style.maxHeight = '22cm';
                        img.style.display = 'block';
                        img.style.margin = '20px auto';
                        diagram.parentNode.replaceChild(img, diagram);
                        continue;
                    }
                    
                    if (!originalCode) continue;
                    
                    const processedCode = preprocessERDiagramCode(originalCode);
                    const isERDiagram = processedCode.toLowerCase().startsWith('erdiagram') ||
                        processedCode.includes('erDiagram');
                    const isComplex = processedCode.includes('subgraph') || processedCode.split('\n').length > 15;
                    
                    mermaidElement.innerHTML = '';
                    mermaidElement.textContent = processedCode;
                    mermaidElement.style.display = 'block';
                    mermaidElement.style.width = '100%';
                    mermaidElement.style.minWidth = isERDiagram ? '800px' : '500px';
                    mermaidElement.style.minHeight = isERDiagram ? '600px' : '400px';
                    
                    await new Promise(r => setTimeout(r, 300));
                    
                    await mermaid.run({
                        nodes: [mermaidElement],
                        suppressErrors: true
                    });
                    
                    const waitMs = isERDiagram ? 3000 : (isComplex ? 2500 : 1500);
                    await new Promise(r => setTimeout(r, waitMs));
                    
                    const svg = mermaidElement.querySelector('svg');
                    const diagramHtml = diagram.innerHTML || '';
                    if (!svg ||
                        diagramHtml.includes('Syntax error') ||
                        diagramHtml.includes('mermaid version') ||
                        diagramHtml.includes('NaN') ||
                        (svg.outerHTML && svg.outerHTML.includes('NaN'))) {
                        throw new Error('Mermaid æ¸²æŸ“ç»“æœæ— æ•ˆ');
                    }
                    
                    const imageData = await convertMermaidToImage(diagram);
                    
                    const img = document.createElement('img');
                    img.src = imageData;
                    img.alt = 'Mermaid å›¾è¡¨';
                    img.style.width = '16.5cm';
                    img.style.maxWidth = '16.5cm';
                    img.style.height = 'auto';
                    img.style.maxHeight = '22cm';
                    img.style.display = 'block';
                    img.style.margin = '20px auto';
                    
                    diagram.parentNode.replaceChild(img, diagram);
                } catch (error) {
                    console.error('Mermaid è½¬å›¾ç‰‡å¤±è´¥:', error);
                    const fallback = document.createElement('div');
                    fallback.style.margin = '12pt 0';
                    fallback.style.padding = '10pt';
                    fallback.style.background = '#f8f9fa';
                    fallback.style.borderLeft = '4px solid #667eea';
                    fallback.innerHTML = `<p style="margin:0 0 8pt 0; color:#666;">[Mermaid å›¾è¡¨å¯¼å‡ºä¸ºå›¾ç‰‡å¤±è´¥ï¼Œä»¥ä¸‹ä¸ºåŸå§‹ä»£ç ï¼Œå¯åœ¨æ”¯æŒ Mermaid çš„ç¼–è¾‘å™¨ä¸­æŸ¥çœ‹]</p><pre style="margin:0; font-size:10pt; overflow-x:auto;"><code>${escapeHtml(originalCode || '')}</code></pre>`;
                    diagram.parentNode.replaceChild(fallback, diagram);
                }
            }
            
            const result = tempDiv.innerHTML;
            const parent = tempDiv.parentNode;
            if (parent) parent.removeChild(tempDiv);
            return result;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å°† HTML ä¸­çš„è¡¨æ ¼è½¬ä¸ºå›¾ç‰‡ï¼ˆå¦‚éœ€æ±‚å…¨æ™¯å·¥ä½œå°ç­‰ï¼‰ï¼Œå¯¼å‡ºåˆ° Word æ—¶ä»¥å›¾ç‰‡å½¢å¼å‘ˆç°
        async function processTablesAsImages(htmlString) {
            const tempDiv = document.createElement('div');
            tempDiv.style.cssText = 'position:absolute;left:-9999px;top:0;width:800px;background:#fff;padding:0;visibility:visible;';
            tempDiv.innerHTML = htmlString;
            document.body.appendChild(tempDiv);
            const tables = Array.from(tempDiv.querySelectorAll('table'));
            for (const table of tables) {
                try {
                    const wrapper = document.createElement('div');
                    wrapper.style.cssText = 'padding:12px;background:#fff;display:inline-block;border:1px solid #e0e0e0;border-radius:4px;';
                    const style = document.createElement('style');
                    style.textContent = 'table{border-collapse:collapse;width:100%;font-size:11pt;font-family:Microsoft YaHei,SimSun,sans-serif;}th,td{border:1px solid #ddd;padding:6px 8px;text-align:left;}th{background:#667eea;color:#fff;font-weight:bold;}tr:nth-child(even){background:#f8f9ff;}';
                    wrapper.appendChild(style);
                    wrapper.appendChild(table.cloneNode(true));
                    document.body.appendChild(wrapper);
                    wrapper.style.position = 'absolute';
                    wrapper.style.left = '-9999px';
                    await new Promise(r => setTimeout(r, 100));
                    const canvas = await html2canvas(wrapper, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        allowTaint: true
                    });
                    document.body.removeChild(wrapper);
                    const dataUrl = canvas.toDataURL('image/png');
                    const img = document.createElement('img');
                    img.src = dataUrl;
                    img.alt = 'è¡¨æ ¼';
                    img.style.maxWidth = '16.5cm';
                    img.style.maxHeight = '22cm';
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.style.display = 'block';
                    img.style.margin = '12pt 0';
                    table.parentNode.replaceChild(img, table);
                } catch (e) {
                    console.warn('è¡¨æ ¼è½¬å›¾ç‰‡å¤±è´¥ï¼Œä¿ç•™åŸè¡¨æ ¼:', e);
                }
            }
            const result = tempDiv.innerHTML;
            if (tempDiv.parentNode) tempDiv.parentNode.removeChild(tempDiv);
            return result;
        }

        // å°† HTML ä¸­çš„ä»£ç å—ï¼ˆpreï¼‰è½¬ä¸ºå›¾ç‰‡ï¼Œé¿å…åœ¨ Word ä¸­æ ¼å¼é”™ä¹±ï¼ˆå¦‚æ¨¡å—ä¾èµ–å…³ç³»ç­‰ï¼‰
        async function processCodeBlocksAsImages(htmlString) {
            const tempDiv = document.createElement('div');
            tempDiv.style.cssText = 'position:absolute;left:-9999px;top:0;width:800px;background:#fff;padding:0;visibility:visible;';
            tempDiv.innerHTML = htmlString;
            document.body.appendChild(tempDiv);
            const pres = Array.from(tempDiv.querySelectorAll('pre'));
            for (const pre of pres) {
                if (pre.closest('.mermaid-diagram')) continue;
                try {
                    const wrapper = document.createElement('div');
                    wrapper.style.cssText = 'padding:12px 16px;background:#f8f9fa;display:inline-block;border:1px solid #e0e0e0;border-radius:4px;font-family:Consolas,Monaco,Microsoft YaHei,monospace;font-size:11pt;line-height:1.5;white-space:pre-wrap;word-break:break-all;max-width:623px;';
                    wrapper.appendChild(pre.cloneNode(true));
                    document.body.appendChild(wrapper);
                    wrapper.style.position = 'absolute';
                    wrapper.style.left = '-9999px';
                    await new Promise(r => setTimeout(r, 100));
                    const canvas = await html2canvas(wrapper, {
                        backgroundColor: '#f8f9fa',
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        allowTaint: true
                    });
                    document.body.removeChild(wrapper);
                    // Word æŒ‰å›¾ç‰‡åƒç´ å°ºå¯¸æ˜¾ç¤ºï¼Œé™åˆ¶ PNG å®½åº¦ 623pxâ‰ˆ16.5cmã€é«˜åº¦ 831pxâ‰ˆ22cm
                    const maxW = 623, maxH = 831;
                    let cw = canvas.width, ch = canvas.height;
                    let finalCanvas = canvas;
                    if (cw > maxW || ch > maxH) {
                        const r = Math.min(maxW / cw, maxH / ch, 1);
                        cw = Math.round(cw * r);
                        ch = Math.round(ch * r);
                        const small = document.createElement('canvas');
                        small.width = cw;
                        small.height = ch;
                        small.getContext('2d').drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, cw, ch);
                        finalCanvas = small;
                    }
                    const dataUrl = finalCanvas.toDataURL('image/png');
                    const img = document.createElement('img');
                    img.src = dataUrl;
                    img.alt = 'ä»£ç å—';
                    img.style.width = '16.5cm';
                    img.style.maxWidth = '16.5cm';
                    img.style.height = 'auto';
                    img.style.maxHeight = '22cm';
                    img.style.display = 'block';
                    img.style.margin = '12pt 0';
                    pre.parentNode.replaceChild(img, pre);
                } catch (e) {
                    console.warn('ä»£ç å—è½¬å›¾ç‰‡å¤±è´¥ï¼Œä¿ç•™åŸå†…å®¹:', e);
                }
            }
            const result = tempDiv.innerHTML;
            if (tempDiv.parentNode) tempDiv.parentNode.removeChild(tempDiv);
            return result;
        }

        // è½¬æ¢å‡½æ•°
        async function convertToWord(markdown) {
            // å¤„ç†Markdownå†…å®¹ï¼Œå¯¹ç‰¹æ®Šä»£ç å—è°ƒç”¨GLMç”Ÿæˆè¯´æ˜
            const processedMarkdown = await processMarkdownWithGLM(markdown);
            // ä¼˜å…ˆä½¿ç”¨å·²æ¸²æŸ“çš„é¢„è§ˆ DOMï¼ˆå« Mermaid SVGï¼‰ï¼Œé¿å…åœ¨éšè—å®¹å™¨ä¸­é‡æ¸²æŸ“å¯¼è‡´å¤±è´¥
            let html;
            if (previewContent.innerHTML && previewContent.querySelector('.mermaid-diagram')) {
                html = previewContent.innerHTML;
            } else {
                html = marked.parse(processedMarkdown);
            }
            
            // å°† Mermaid å›¾è¡¨ï¼ˆSVGï¼‰è½¬ä¸ºå›¾ç‰‡åå†å¯¼å‡ºåˆ° Wordï¼›è¡¨æ ¼ä¿æŒä¸º Word åŸç”Ÿè¡¨æ ¼ï¼Œä¸è½¬æˆå›¾ç‰‡
            html = await processMermaidInHTML(html);
            // å°†ä»£ç å—ï¼ˆpreï¼‰è½¬ä¸ºå›¾ç‰‡ï¼Œé¿å…åœ¨ Word ä¸­æ ¼å¼é”™ä¹±ï¼ˆå¦‚æ¨¡å—ä¾èµ–å…³ç³»ç­‰ï¼‰
            html = await processCodeBlocksAsImages(html);
            
            // åˆ›å»ºå®Œæ•´çš„ HTML æ–‡æ¡£ç»“æ„ï¼ŒåŒ…å«æ ·å¼
            const fullHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: "Microsoft YaHei", "SimSun", Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.6;
            margin: 40px;
            color: #333;
        }
        h1 {
            font-size: 24pt;
            font-weight: bold;
            margin: 20pt 0 12pt 0;
            border-bottom: 2px solid #333;
            padding-bottom: 6pt;
        }
        h2 {
            font-size: 18pt;
            font-weight: bold;
            margin: 16pt 0 10pt 0;
        }
        h3 {
            font-size: 14pt;
            font-weight: bold;
            margin: 14pt 0 8pt 0;
        }
        h4 {
            font-size: 12pt;
            font-weight: bold;
            margin: 12pt 0 6pt 0;
        }
        h5, h6 {
            font-size: 11pt;
            font-weight: bold;
            margin: 10pt 0 6pt 0;
        }
        p {
            margin: 6pt 0;
        }
        ul, ol {
            margin: 6pt 0 6pt 20pt;
        }
        li {
            margin: 3pt 0;
        }
        blockquote {
            border-left: 4px solid #ccc;
            padding-left: 12pt;
            margin: 12pt 0;
            color: #666;
            font-style: italic;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 12pt 0;
            font-size: 11pt;
        }
        table th {
            background-color: #667eea;
            color: white;
            font-weight: bold;
            padding: 8pt;
            border: 1px solid #ddd;
            text-align: center;
        }
        table td {
            padding: 6pt 8pt;
            border: 1px solid #ddd;
            text-align: left;
        }
        table tr:nth-child(even) {
            background-color: #f8f9ff;
        }
        img {
            width: 16.5cm;
            max-width: 16.5cm;
            max-height: 22cm;
            height: auto;
            margin: 12pt 0;
            display: block;
        }
        code {
            background-color: #f4f4f4;
            padding: 2pt 4pt;
            border-radius: 3pt;
            font-family: "Courier New", monospace;
            font-size: 10pt;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10pt;
            border-radius: 5pt;
            overflow-x: auto;
        }
        pre code {
            background: none;
            padding: 0;
        }
    </style>
</head>
<body>
${html}
</body>
</html>
            `;

            // æ£€æŸ¥ html-docx-js æ˜¯å¦å·²åŠ è½½å¹¶è½¬æ¢
            let converted;
            try {
                if (typeof HTMLDocx !== 'undefined' && HTMLDocx.asBlob) {
                    // ä½¿ç”¨ HTMLDocx.asBlob æ–¹æ³•
                    converted = HTMLDocx.asBlob(fullHtml);
                } else if (typeof htmlDocx !== 'undefined' && htmlDocx.asBlob) {
                    // å°è¯•å¦ä¸€ç§å¯èƒ½çš„å…¨å±€å˜é‡å
                    converted = htmlDocx.asBlob(fullHtml);
                } else if (typeof asBlob !== 'undefined') {
                    // ç›´æ¥ä½¿ç”¨ asBlob å‡½æ•°
                    converted = asBlob(fullHtml);
                } else {
                    // å¦‚æœåº“æœªåŠ è½½ï¼ŒæŠ›å‡ºé”™è¯¯
                    const errorMsg = 'Word è½¬æ¢åº“æœªæ­£ç¡®åŠ è½½ã€‚\n' +
                        'è¯·æ£€æŸ¥ï¼š\n' +
                        '1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n' +
                        '2. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯\n' +
                        '3. å°è¯•åˆ·æ–°é¡µé¢é‡è¯•\n\n' +
                        'è°ƒè¯•ä¿¡æ¯ï¼š\n' +
                        `- HTMLDocx: ${typeof HTMLDocx}\n` +
                        `- htmlDocx: ${typeof htmlDocx}\n` +
                        `- asBlob: ${typeof asBlob}`;
                    throw new Error(errorMsg);
                }
                
                // ä¸‹è½½æ–‡ä»¶
                const fileName = currentFileName || 'document';
                saveAs(converted, `${fileName}.docx`);
            } catch (error) {
                console.error('è½¬æ¢è¿‡ç¨‹ä¸­çš„é”™è¯¯:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
